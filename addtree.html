<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
<title>昌平区园林绿化局古树名木管理系统</title>
<link href="style/css.css" rel="stylesheet">
</head>
<body resizeType="managelist">
<div id="loading">
    <div class="spinner">
    <div class="bounce1"></div>
    <div class="bounce2"></div>
    <div class="bounce3"></div>
    </div>
</div>
<div class="commonbox" setwidth="1600" setheight="850" setmargin="-425px 0 0 -800px">
	<div class="nav">
		<ul>
			<li class="nav-login icon" link="index.html">
				<div class="icon nav-logon"></div>
			</li>
			<li class="nav-search icon" title="查询" link="search.html"></li>
			<li class="nav-manage icon active" title="管理" link="manage.html"></li>
			<li class="nav-stat icon" title="统计" link="tongji.html"></li>
		</ul>
	</div>
	<div class="showbox">
		<div class="manage-pub">
			<div class="manage-pub-title clear">
				<div class="manage-pub-type manage-pub-add fl"></div>
				<!-- <div class="form-fz fl">
					<div class="bar-search">
						<div class="icon submit-search" type=""></div>
						<input type="text" class="searchvalue" placeholder="请输古树编号、小地名、时间查询">
					</div>
				</div> -->
				<div class="manage-pub-btns fl" style="position: relative;margin:-20px 0 0 40px;">
					<span title="新增" class="manage-btn-add icon"></span><span title="编辑" class="manage-btn-edit icon"></span><span title="删除" class="manage-btn-del icon"></span>
				</div>
			</div>
			<div class="search-list manage-pub-search">
				<div class="copytable">
					<table>
						<tr>
							<th>编号<em class="icon arrow-s"></em></th>
							<th>地区</th>
							<th>树种</th>
						</tr>
					</table>
				</div>
				</div>
				<div class="autoscroll">
					
				</div>
			</div>
		</div>
	</div>
</div>

<div class="dialogwrite">
	<div class="writetree">
		<div class="write-close">×</div>
		<div class="write-con">
			<div class="write-tit">基本信息</div>
			<ul class="clear">
				<li>古树名木编号：<input type="text" placeholder="请输入古树编号" name="NO"></li>
                <li>原挂牌号：<input type="text" placeholder="请输入原挂牌号" name="quotation"></li>
                <li>特征代码：<input type="text" placeholder="请输入特征代码" name="feature_no"></li>
                <li>所属区县：<input type="text" placeholder="请输入特征代码" name="feature_no"></li>
                <li>古树等级：<input type="text" placeholder="请输入古树等级" name="grade"></li>
                <li>树种：<select name="tree_seed"><option value="">--请选择--</option>
						    <option value="侧柏">侧柏</option>
						    <option value="桧柏">桧柏</option>
						    <option value="油松">油松</option>
						    <option value="白皮松">白皮松</option>
						    <option value="雪松">雪松</option>
						    <option value="银杏">银杏</option>
						    <option value="栾树">栾树</option>
						    <option value="元宝枫">元宝枫</option>
						    <option value="白玉兰">白玉兰</option>
						    <option value="楸树">楸树</option>
						    <option value="榆树">榆树</option>
						    <option value="七叶树">七叶树</option>
						    <option value="国槐">国槐</option>
						    <option value="水杉">水杉</option>
						    <option value="桑树">桑树</option>
						    <option value="枣树">枣树</option>
						    <option value="朴树">朴树</option>
						    <option value="黑枣">黑枣</option>
						    <option value="丝绵木">丝绵木</option>
						    <option value="核桃">核桃</option>
						    <option value="杜梨">杜梨</option>
						    <option value="龙爪槐">龙爪槐</option>
						    <option value="杜仲">杜仲</option>
						    <option value="流苏">流苏</option>
						    <option value="梓树">梓树</option>
						    <option value="黄金树">黄金树</option>
						    <option value="皂角">皂角(皂荚)</option>
						    <option value="臭椿">臭椿(香椿)</option>
						    <option value="梧桐">梧桐</option>
						    <option value="白蜡">白蜡</option>
						    <option value="小叶椴">小叶椴(蒙椴)</option>
						    <option value="卫矛">卫矛</option>
						    <option value="洋槐">洋槐</option>
						</select></li>
                <li>估测树龄：<input type="text" placeholder="请输入估测树龄" name="estimation_age"></li>
                <li>真实树龄：<input type="text" placeholder="请输入真实树龄" name="real_age"></li>
                <li>树高(m)：<input type="text" placeholder="树高高度" name="higth"></li>
                <li>胸径(主蔓径)(cm)：<input type="text" placeholder="胸径(厘米)" name="chest"></li>
                <li>生长势：<select name="growth_vigor"><option value="">--请选择--</option>
					    <option value="良好">良好</option>
					    <option value="衰弱">衰弱</option>
					    <option value="濒危">濒危</option>
					</select></li>
                <li>生长环境：<select name="growth_enviro"><option value="">--请选择--</option>
					    <option value="良好">良好</option>
					    <option value="合格">合格</option>
					    <option value="差">差</option>
					</select></li>
                <li>特点：<select name="feature"><option value="">--请选择--</option><option>群状</option><option>散生</option></select></li>
            </ul>

			<div class="write-tit">位置</div>
            <ul class="clear">
                <li>乡镇：<select name="town"><option value="">--请选择--</option><option>小汤山镇</option><option>兴寿镇</option><option>城北街道</option><option>南口地区</option><option>马池口地区</option><option>沙河地区</option> <option>城南街道</option><option>回龙观地区</option><option>阳坊镇</option><option>南邵镇</option><option>崔村镇</option><option>百善镇</option><option>北七家镇</option><option>长陵镇</option></select></li>
                <li>村(居委会)：<input type="text" placeholder="村(居委会)" name="villiage"></li>
                <li>小地名：<input type="text" placeholder="请输入小地名" name="small_place"></li>
                <li>生长场所：<select name="product_place"><option value="">--请选择--</option>
				    <option value="远郊野外">远郊野外</option>
				    <option value="乡村街道">乡村街道</option>
				    <option value="区县城区">区县城区</option>
				    <option value="市区范围">市区范围</option>
				    <option value="自然保护区">自然保护区</option>
				    <option value="风景名胜区">风景名胜区</option>
				    <option value="森林公园">森林公园</option>
				    <option value="历史文化街区及历史名园">历史文化街区及历史名园</option>
				    </select></li>
                <li>现存状态：<select name="exist_state"><option value="">--请选择--</option>
				    <option value="正常">正常</option>
				    <option value="死亡">死亡</option>
				    </select></li>
                <li>调查号：<input type="text" placeholder="请输入调查号" name="survey_no"></li>
                <li>海拔(m)：<input type="text" placeholder="请输入海拔" name="altitude"></li>
            </ul>
            <ul>
                <li>横坐标：<input type="text" name="X" placeholder="打开右侧按钮选择"/></li>
				<li>纵坐标：<input type="text" name="Y" placeholder="打开右侧按钮选择"/></li>
				<li><input type="button" id="openmap" value="在地图上选取坐标" style="cursor:pointer;background-color:#547543;color:#fff;" title="打开地图选取纵坐标和横坐标"></li>

            </ul>
            <div class="write-tit">树冠</div>
            <ul class="clear">
                <li>东西树冠(m)：<input type="text" placeholder="请输入东西树冠" name="east_crown"></li>
                <li>南北树冠(m)：<input type="text" placeholder="请输入南北树冠" name="south_crown"></li>
                <li>平均树冠(m)：<input type="text" placeholder="请输入平均树冠" name="aver_crown"></li>
            </ul>
            <div class="write-tit">管护</div>
            <ul class="clear">
                <li>管护单位：<select name="manage_com"><option value="">--请选择--</option>
					    <option value="城建集团">城建集团</option>
					    <option value="西山林场">西山林场</option>
					    <option value="海淀农林委">海淀农林委</option>
					    <option value="海淀市政">海淀市政</option>
					    <option value="公园管理中心">公园管理中心</option>
	    			</select></li>
                <li>管护人：<input type="text" placeholder="请输入管护人" name="manage_people"></li>
            </ul>;
            <div class="upload">图片上传：<label for="uploadimg" class="label-file">上传图片</label><input type="file" id="uploadimg" accept="image/*" hidden></div>
			<div class="uploadlist clear">
				
			</div>
			<div class="write-btns">
				<span class="btns-submit">添加古树</span><span class="btns-clear">清空表单</span><span class="btns-cancel">取消添加</span>
			</div>

		</div>
	</div>
</div>
<div class="dialogwrite" style="background-color:rgba(0,0,0,0.1);">
	<div class="writetree">
		<div class="write-close">×</div>
		<div id="allmap" style="width:100%;height:100%"></div>
		<div style="position:absolute;left:0;top:0;z-index:4;background-color:rgba(255,255,255,0.8);padding:10px;">
			<p style="margin-bottom:10px;">横坐标：<input type="text" name="X" readyonly/></p>
			<p>纵坐标：<input type="text" name="Y" readyonly/></p>
		</div>
	</div>
</div>
<script src="js/jquery.js"></script>
<script src="js/common.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=2lekLZRu8XcblvoAMksUK3qmGnISyCSP"></script>
<script type="text/javascript">
$(function (){
	var searchList=$(".search-list");
	var sentImgUrl='';
	document.getElementById("uploadimg").onchange=function (event){
		var files=event.target.files;
		for(var i=0;i<files.length;i++){
			getImgBase64(files[i]);
		}
		
	}
	function getImgBase64(image){
		var reader = new FileReader();
		
		reader.onload=function (e){
			var baseimg=e.target.result;
			$.ajax({
				type:"get",
				url:"/inf/uploadTreePicture",
				data:{"image_code":baseimg},
				dataType:"jsonp",
				error:function (){
					dialogMessage("上传图片","上传图片出错，请您稍后重试！");
				},
				success:function (data){
					if(data.status==200){
						var imgsrc=data.data.url;
						sentImgUrl+=","+imgsrc;
						var oImg='<div class="image"><img src="'+imgsrc+'"><div class="delimg" title="删除">×</div></div>'
						$(".uploadlist").eq(0).append(oImg);
					}else{
						var errormsg=data.error || "上传图片出错，请您稍后重试！";
						dialogMessage("上传图片",errormsg);
					}
					
				}
			});
			
		}
		reader.readAsDataURL(image);
	}
	$(".uploadlist").delegate(".delimg","click",function (){
		$(this).parent().remove();
	});
	$(".write-close").click(function (){
		$(this).parents(".dialogwrite").hide();
	});
	$(".manage-btn-add").click(function (){
		$(".dialogwrite").eq(0).show();
	});
	function loadNewTree(op){
		var option=$.extend({page_index:1,page_num:20,type:1},op);
		$.ajax({
			"type":"get",
			url:"/inf/getLocation",
			data:option,
			dataType:"json",
			error:function (){dialogMessage("新增古树信息","新增古树信息暂时无法加载，请您稍后重试！");},
			success:function (data){
				if(data && data.status == 200){
	                var arry=data.data || [];
	                if(arry.length<1) return false;
	                var table='<table>';
	                for(var i=0;i<arry.length;i++){
	                    var NO=arry[i].NO || "树木编号";
	                    var treeAdress=arry[i].town || "-";
	                    var treeName=arry[i].tree_seed || "-";
	                    var lng=arry[i].X || 0;
	                    var lat=arry[i].Y || 0;
	                    table+='<tr lng="'+lng+'" lat="'+lat+'" postnum="'+postNum+'" type="'+treeName+'" address="'+treeAdress+'">'+
	                               '<td>'+NO+'</td>'+
	                               '<td>'+treeAdress+'</td>'+
	                               '<td>'+treeName+'</td>'
	                            '</tr>';
						
						
	                }
					table+='</table>';
	                var totalcount=data.records || 0;
	                var pagehtml=returnPagehtml(option.page_index,totalcount,option.page_num);
					
					searchList.find(".pagenumber").empty().html(pagehtml).delegate("a","click",function (){
						var t=$(this);
						if(t.hasClass("now") || t.hasClass("last")) return false;
						var number=t.attr("page");
						loadSearchData({page_index:number});						
					});
	                searchList.show().find(".autoscroll").empty().html(table);
					searchList.find(".autoscroll").find("tr").eq(0).find("td").each(function (i,ele){
                        searchList.find(".copytable").find("th").eq(i).width($(ele).width());
                     }); 
	            }else{
					var errormsg=data.error || '加载新增古树出错，请您重试'
						dialogMessage("古树信息",errormsg);
				}
			}

		});
	}
	function submitNewTreeInfo(){
		var option={picture:sentImgUrl.substr(1)};
		$(".dialogwrite").find("input[type='text']").each(function (){
			var name=$(this).attr("name");
			option[name]=$(this).val();
		});
		$(".dialogwrite").find("select").each(function (){
			var name=$(this).attr("name");
			option[name]=$(this).val();
		});
		console.info(option);
		/*
		X:x坐标,Y:Y坐标,NO:古树编号,picture:多个url用逗号分隔,county:区县,quotation:原挂牌号,feature_no:特征代码,tree_seed:树种,grade:等级,estimation_age:估测树龄,real_age:真实树龄,higth:树高,chest:胸围,feature:特点,growth_vigor:生长势,growth_enviro:生长环境,town:乡镇,villiage:村,small_place:小地名,product_place:生长场所,exist_state:现存状态,survey_no:调查号,altitude:海拔,aver_crown:平均冠幅,east_crown:东西冠幅,south_crown:南北冠幅,manage_com:管护单位,
manage_people:管护人
		 */
		$.ajax({
			"type":"get",
			url:"/inf/treeAdd",
			data:option,
			dataType:"json",
			error:function (){},
			success:function (data){
				
			}

		});
	}
	$(".btns-submit").click(function (){
		submitNewTreeInfo();
	}).siblings(".btns-clear").click(function (){
		$(".dialogwrite").find("input[type='text']").each(function (){
			$(this).val("");
		});
		$(".dialogwrite").find("select").each(function (){
			$(this).val("");
		});
	}).siblings(".btns-cancel").click(function (){
		$(this).parents(".dialogwrite").hide();
	});
	var overlayOffice;
	
	$("#openmap").click(function (){
		if($(this).attr("load")=="loaded"){
			$(this).attr("load","loaded");
			return false;
		}
		$(".dialogwrite").eq(1).show();
		var map = new BMap.Map("allmap");            
		map.centerAndZoom("昌平",12); 
		map.enableScrollWheelZoom(true);         
		//单击获取点击的经纬度
		map.addEventListener("click",function(e){
			$("input[name='X']").val(e.point.lng);
			$("input[name='Y']").val(e.point.lat);
		});
		var bdary = new BMap.Boundary();
	    bdary.get("昌平区", function(rs){//获取行政区域
	        map.removeOverlay(overlayOffice);
	        var arry=rs.boundaries[0].split(";");
	        var len=arry.length;
	        var polygon=[];
	        var viewArry=[];
	        for(var i=0;i<len;i++){
	            polygon.push(new BMap.Point(arry[i].split(",")[0],arry[i].split(",")[1]));
	            var view={lat:arry[i].split(",")[1],lng:arry[i].split(",")[0]};
	            viewArry.push(view);
	        }
	        overlayOffice = new BMap.Polyline(polygon,{strokeColor:"red", strokeWeight:2, strokeOpacity:1,enableMassClear:false});
	        map.addOverlay(overlayOffice);
	        map.setViewport(viewArry);
	    });
	});
});
</script>
</body>
</html>
